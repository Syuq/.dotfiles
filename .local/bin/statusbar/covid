#!/bin/bash

# Set country by running this command `covid country_name`
country="$1"
# Default country is Vietnam if it's not set
[ -z "${country}" ] && country="VN"

API_URL="https://ncovi.vnpt.vn/thongtindichbenh_v2?fbclid=IwAR2lXZ4T3pGJEHJiZqogQJVJUxbKyxe9-PYaOGTykKz8Dgxf-tvMy1jG3kE"

# Get information about Covid-19 in ${country}
info="`curl -s ${API_URL} | awk -F'}, {' '{ for (i = 1; i < 290; ++i) print $i; }' |
    grep -i "${country}" | awk -F',' '{ for (i = 1; i < 11; ++i) print $i;}'`"

array=($info)
for i in "${!array[@]}"; do
    [[ "${array[i]}" == *'"confirmed":'* ]]             && confirmed="${array[++i]}"
    [[ "${array[i]}" == *'"increase_confirmed":'* ]]    && inc_confirmed="${array[++i]}"
    [[ "${array[i]}" == *'"deaths":'* ]]                && deaths="${array[++i]}"
    [[ "${array[i]}" == *'"increase_deaths":'* ]]       && inc_deaths="${array[++i]}"
    [[ "${array[i]}" == *'"recovered":'* ]]             && recovered="${array[++i]}"
    [[ "${array[i]}" == *'"increase_recovered":'* ]]    && inc_recovered="${array[++i]}"
done

output="ðŸ¥µ ${confirmed}(+${inc_confirmed}),ðŸ’€ $deaths(+${inc_deaths}),ðŸ¤£ $recovered(+${inc_recovered})"

# If ${confirmed} is empty, print out covid.log
[ -z "${confirmed}" ] && cat ~/Public/covid.log 2&> /dev/null && exit

printf "${output}" > ~/Public/covid.log
printf "${output}"

exit 0
